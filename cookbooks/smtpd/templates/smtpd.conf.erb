# OpenSMTPD configuration
# Role: <%= @mail_role %>
# Generated by mitamae

fqdn = "<%= @fqdn %>"
pki main cert "<%= @tls_cert %>"
pki main key "<%= @tls_key %>"

smtp limit max-mails 10
smtp limit max-rcpt 5
smtp max-message-size 100M

table vdomains file:/etc/mail/vdomains
<% if @mail_role == 'primary' -%>
table vusers file:/etc/mail/vusers
table passwd passwd:/etc/mail/passwd

# filter "rspamd" proc-exec "filter-rspamd"
# listen on socket filter "rspamd"

# filter "rspamd"
listen on all port 25 tls pki main \
    hostname $fqdn tag MTA
    
# filter "rspamd"
listen on all port 587 tls-require pki main \
    hostname $fqdn tag MSA auth <passwd> mask-src

action "deliver" \
    mda "/usr/local/libexec/dovecot/dovecot-lda -d %{dest} -r %{rcpt} -f %{sender}" \
    virtual <vusers> user "vmail"

action "relay" relay helo $fqdn

match from any for domain <vdomains> action "deliver"
match from any auth for any action "relay"
match from local for local action "deliver"
match from local for domain <vdomains> action "deliver"
match from local for any action "relay"
<% else -%>
listen on egress port 25 tls pki main \
    hostname $fqdn tag MTA

action "relay" relay helo $fqdn
action "local" mbox

match for local action "local"
match from any for domain <vdomains> action "relay"
<% end -%>
