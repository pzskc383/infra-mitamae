# Role: <%= @mail_role %>

fqdn = "<%= @fqdn %>"
pki fqdn cert "<%= @tls_cert %>"
pki fqdn key "<%= @tls_key %>"

smtp limit max-mails 10
smtp limit max-rcpt 5
smtp max-message-size 100M

table vdomains file:/etc/mail/vdomains
<%- if @mail_role == 'primary' -%>
table vusers file:/etc/mail/vusers
table passwd file:/etc/mail/passwd

listen on all port 25 tls pki fqdn \
    hostname $fqdn tag MTA
    
listen on all port 587 tls-require pki fqdn \
    hostname $fqdn tag MSA auth <passwd> mask-src

action "deliver-lda" \
    mda "/usr/local/libexec/dovecot/dovecot-lda -d %{dest} -r %{rcpt} -a %{rcpt:strip} -f %{mbox.from}" \
    virtual <vusers> user "vmail"
    
action "deliver" lmtp "/var/dovecot/lmtp" rcpt-to virtual <vusers>

action "relay" relay helo $fqdn

match from any for domain <vdomains> action "deliver"
match from any auth for any action "relay"
match from local for local action "deliver"
match from local for domain <vdomains> action "deliver"
match from local for any action "relay"
<%- else -%>
listen on egress port 25 tls pki fqdn \
    hostname $fqdn tag MTA

action "relay" relay helo $fqdn
action "local" mbox

match for local action "local"
match from any for domain <vdomains> action "relay"
<%- end -%>
