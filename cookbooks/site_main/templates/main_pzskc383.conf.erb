# main domain
server "main" {
    alias "pzskc383.net"

    listen on $loopback port $serve_port

    log {
        style forwarded
        access "access.main.log"
        error "error.main.log"
    }

    # autoconf on main domain
    location "/.well-known/autoconfig/mail/config-v1.1.xml" {
        root "/mail/pzskc383.net/autoconfig"
        request strip 3
        pass
    }

    # cgit static
    location match "^/code/cgit/%w+%.%w+$" {
        log {
            style forwarded
            access "access.cgit.log"
            error "error.cgit.log"
        }
        root "/cgit"
        request strip 2
        no fastcgi
    }

    # git dumb static
    location match "^/code/[^/]+/objects/%x%x/%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }

    location match "^/code/[^/]+/objects/pack/pack-%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x.pack$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }

    location match "^/code/[^/]+/objects/pack/pack-%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x.idx$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }


    location "/code/*/git-upload-pack" {
        request strip 1
        log {
            style forwarded
            access "access.git-backend.log"
            error "error.git-backend.log"
        }
        root "/usr/local/libexec/git/git-http-backend"
        fastcgi {
            socket "/run/slowcgi.sock"
            param DOCUMENT_ROOT "/"
            param GIT_PROJECT_ROOT "/repos"
            param GIT_HTTP_EXPORT_ALL "true"
            param HOME "/repos"
        }
    }

    location "/code/*/info/refs" {
        request strip 1
        log {
            style forwarded
            access "access.git-backend.log"
            error "error.git-backend.log"
        }
        root "/usr/local/libexec/git/git-http-backend"
        fastcgi {
            socket "/run/slowcgi.sock"
            param DOCUMENT_ROOT "/"
            param GIT_PROJECT_ROOT "/repos"
            param GIT_HTTP_EXPORT_ALL "true"
            param HOME "/repos"
        }
    }

    # cgit
    location "/code/*" {
        root "/cgi-bin/cgit.cgi"
        log {
            style forwarded
            access "access.cgit.log"
            error "error.cgit.log"
        }
        request strip 1
        fastcgi {
            socket "/run/slowcgi.sock"
        }
    }

    location * {
        root "/htdocs"
    }
}
