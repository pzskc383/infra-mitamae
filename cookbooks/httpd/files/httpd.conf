include "/etc/httpd.macro.conf"
loopback = "127.0.0.1"

errdocs "errdocs/"

prefork 2

server "default" {
    log {
        style forwarded
        access "access.default.log"
        error "error.default.log"
    }

    listen on $loopback port $redirect_port
    listen on $loopback port $serve_port

    block drop
}


# http -> https redirects
server "main_plain" {
    alias "*.pzskc383.net"
    alias "pzskc383.net"

    listen on $loopback port $redirect_port

    log {
        style forwarded
        access "access.redir.log"
        error "error.redir.log"
    }

    location * {
        block return 302 "https://$HTTP_HOST$REQUEST_URI"
    }
}

# also, old domain -> new
server "old_plain" {
    alias "*.pzskc383.dp.ua"
    alias "pzskc383.dp.ua"

    listen on $loopback port $redirect_port

    log {
        style forwarded
        access "access.redir.log"
        error "error.redir.log"
    }

    location * {
        block return 302 "https://pzskc383.net$REQUEST_URI"
    }
}

# main domain
server "main" {
    alias "pzskc383.net"

    listen on $loopback port $serve_port

    log {
        style forwarded
        access "access.main.log"
        error "error.main.log"
    }

    # autoconf on main domain
    location "/.well-known/autoconfig/mail/config-v1.1.xml" {
        root "/mail/pzskc383.net/autoconfig"
        request strip 3
        pass
    }

    # cgit static
    location match "^/code/cgit/%w+%.%w+$" {
        log {
            style forwarded
            access "access.cgit.log"
            error "error.cgit.log"
        }
        root "/cgit"
        request strip 2
        no fastcgi
    }

    # git dumb static
    location match "^/code/[^/]+/objects/%x%x/%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }

    location match "^/code/[^/]+/objects/pack/pack-%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x.pack$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }

    location match "^/code/[^/]+/objects/pack/pack-%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x.idx$" {
        request strip 1
        root "/repos"
        log {
            style forwarded
            access "access.git-dumb.log"
            error "error.git-dumb.log"
        }
    }


    location "/code/*/git-upload-pack" {
        request strip 1
        log {
            style forwarded
            access "access.git-backend.log"
            error "error.git-backend.log"
        }
        root "/usr/local/libexec/git/git-http-backend"
        fastcgi {
            socket "/run/slowcgi.sock"
            param DOCUMENT_ROOT "/"
            param GIT_PROJECT_ROOT "/repos"
            param GIT_HTTP_EXPORT_ALL "true"
            param HOME "/repos"
        }
    }

    location "/code/*/info/refs" {
        request strip 1
        log {
            style forwarded
            access "access.git-backend.log"
            error "error.git-backend.log"
        }
        root "/usr/local/libexec/git/git-http-backend"
        fastcgi {
            socket "/run/slowcgi.sock"
            param DOCUMENT_ROOT "/"
            param GIT_PROJECT_ROOT "/repos"
            param GIT_HTTP_EXPORT_ALL "true"
            param HOME "/repos"
        }
    }

    # cgit
    location "/code/*" {
        root "/cgi-bin/cgit.cgi"
        log {
            style forwarded
            access "access.cgit.log"
            error "error.cgit.log"
        }
        request strip 1
        fastcgi {
            socket "/run/slowcgi.sock"
        }
    }

    location * {
        root "/htdocs"
    }
}

# not sure if needed
server "bare_ip" {
	#alias match "%d+%.%d+%.%d+%.%d+"
	#alias match "%w*::*"
	alias "139.162.204.177"
	alias "2a01:7e00::f03c:92ff:fe91:dc38"

    log {
        style forwarded
        access "access.bare.log"
        error "error.bare.log"
    }

    listen on $loopback port $redirect_port
    listen on $loopback port $serve_port

    # acme dir
	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}

    location * {
        block return 404
    }
}



types {
    include "/usr/share/misc/mime.types"
}
