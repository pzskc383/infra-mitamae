schema "/etc/ldap/core.schema"
schema "/etc/ldap/inetorgperson.schema"
schema "/etc/ldap/nis.schema"
schema "/etc/ldap/bsd.schema"
schema "/etc/ldap/misc.schema"

listen on lo0 secure
listen on "/var/run/ldapi"

namespace "<%= @base_dn %>" {
    rootdn "<%= @bind_dn %>"
    rootpw "<%= @bind_pw %>"
    index cn
    index uid
    index mail
}

# read access allowed to subtrees
allow read access to subtree "<%= @base_dn %>" by self

# deny access to users directly reading the userPassword field
deny read access to subtree "ou=people,<%= @base_dn %>" attribute "userPassword"
deny read access to subtree "ou=services,<%= @base_dn %>" attribute "userPassword"

# allow ourselves to write the attribute
allow read,write access to subtree "ou=people,<%= @base_dn %>" attribute "userPassword" by self

# allow services to read the password
<%- @service_accounts.each do |account| %>
allow read access to subtree "ou=people,<%= @base_dn %>" attribute "userPassword" by "cn=#{account},ou=services,<%= @base_dn %>"
<%- end %>
